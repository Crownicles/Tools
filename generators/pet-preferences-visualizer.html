<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√©f√©rences d'Exp√©dition des Familiers</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --accent: #b91c1c;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;

            /* Terrain Colors */
            --color-plains: #dcfce7;
            --color-forest: #dcfce7;
            --color-coast: #dbeafe;
            --color-mountain: #ffffff;
            --color-desert: #fef3c7;
            --color-swamp: #ecfccb;
            --color-ruins: #f1f5f9;
            --color-cave: #f3f4f6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--text-primary);
            font-weight: 800;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select {
            background: white;
            border: 1px solid #cbd5e1;
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            flex-grow: 1;
        }

        .pet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .pet-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .pet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .pet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pet-id {
            background: #f1f5f9;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .pet-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .preference-section {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            background: #fdfdfd;
            border: 1px solid #e2e8f0;
        }

        .preference-section.liked {
            border: 2px solid var(--success);
            background: #f0fdf4;
        }

        .preference-section.disliked {
            border: 2px solid var(--danger);
            background: #fef2f2;
        }

        .preference-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: 0.05em;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .tag.plains { background-color: var(--color-plains); }
        .tag.forest { background-color: var(--color-forest); }
        .tag.coast { background-color: var(--color-coast); }
        .tag.mountain { background-color: var(--color-mountain); border-color: #cbd5e1; }
        .tag.desert { background-color: var(--color-desert); }
        .tag.swamp { background-color: var(--color-swamp); }
        .tag.ruins { background-color: var(--color-ruins); }
        .tag.cave { background-color: var(--color-cave); color: #475569; }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        .terrain-icons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .terrain-filter {
            background: #f1f5f9;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            color: #475569;
            font-weight: 500;
        }

        .terrain-filter.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        .btn-load {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-load:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <header>
            <h1>Pr√©f√©rences d'Exp√©dition des Familiers</h1>
        </header>

        <div class="card">
            <div class="controls">
                <input type="text" id="searchInput" placeholder="Rechercher par nom ou ID...">
                <select id="preferenceFilter">
                    <option value="all">Toutes les pr√©f√©rences</option>
                    <option value="liked">Aime seulement</option>
                    <option value="disliked">D√©teste seulement</option>
                </select>
                <select id="sortBy">
                    <option value="id">Trier par ID</option>
                    <option value="name">Trier par Nom</option>
                    <option value="likesCount">Trier par Nb. Aimes (D√©croissant)</option>
                    <option value="dislikesCount">Trier par Nb. D√©testes (D√©croissant)</option>
                </select>
                <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
                    <select id="branchSelect" style="flex: 2;">
                        <option value="">Chargement des branches...</option>
                    </select>
                    <button id="loadGitHubData" class="btn-load" style="flex: 1;">
                        <i class="fas fa-sync" id="loadIcon"></i> Charger
                    </button>
                </div>
                <div id="loadingStatus" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem; display: none;">
                    <i class="fas fa-spinner fa-spin"></i> <span id="statusText">Chargement en cours...</span>
                </div>
            </div>
            
            <div id="terrainFilters" class="terrain-icons"></div>

            <div id="petGrid" class="pet-grid"></div>
        </div>
    </div>

    <script>
        const PET_NAMES = {
            1: "üê∂ Chien", 2: "üê© Caniche", 20: "ü¶ä Renard", 28: "üê∫ Loup",
            3: "üê± Chat", 4: "üêà‚Äç‚¨õ Chat Noir", 56: "üêØ Tigre", 57: "ü¶Å Lion", 60: "üêÜ L√©opard",
            5: "üê≠ Souris", 6: "üêπ Hamster", 7: "üê∞ Lapin", 35: "ÔøΩÔøΩ Raton Laveur", 40: "üêøÔ∏è Tamias", 41: "ü¶î H√©risson", 93: "üêÄ Rat",
            8: "üêÑ Vache", 9: "ÔøΩÔøΩ Cochon", 17: "üêë Mouton", 18: "üêê Ch√®vre", 96: "ü´è √Çne",
            10: "üêî Poule", 12: "ü¶Ü Canard", 19: "ü¶É Dindon", 92: "üê§ Poussin", 97: "ü™ø Oie",
            11: "üê¶ Oiseau", 26: "ü¶â Chouette", 27: "ü¶á Chauve-souris", 33: "ü¶¢ Cygne", 34: "ü¶© Flamant Rose", 53: "ü¶ö Paon", 54: "ü¶ú Perroquet", 58: "ü¶Ö Aigle", 62: "üïäÔ∏è Colombe", 94: "üê¶‚Äç‚¨õ Merle", 95: "üê¶‚Äç‚¨õ Corbeau", 59: "ü¶§ Dodo",
            13: "üêé Cheval", 47: "ü¶ì Z√®bre", 98: "ü´é √âlan",
            14: "üê¢ Tortue", 15: "üêç Serpent", 16: "ÔøΩÔøΩ L√©zard", 44: "ü¶Ç Scorpion", 45: "üêä Crocodile",
            21: "üêª Ours", 42: "üêª‚Äç‚ùÑÔ∏è Ours Polaire", 43: "üêº Panda",
            23: "üê∏ Grenouille",
            24: "üêí Singe", 90: "ü¶ß Orang-outan", 91: "ü¶ç Gorille",
            25: "üêß Manchot", 72: "üêß Manchot Empereur", 30: "ü¶≠ Phoque",
            22: "üê® Koala", 52: "ü¶ò Kangourou",
            31: "ü¶õ Hippopotame", 46: "üêò √âl√©phant", 48: "ü¶è Rhinoc√©ros", 51: "ü¶í Girafe",
            29: "üêó Sanglier", 32: "ü¶ô Lama", 49: "üê™ Dromadaire", 50: "üê´ Chameau",
            36: "ü¶® Moufette", 37: "ü¶° Blaireau", 38: "ü¶´ Castor", 39: "ü¶• Paresseux", 55: "ü¶¶ Loutre", 87: "ü¶å Cerf", 88: "üêÉ Buffle d'eau", 89: "ü¶¨ Bison",
            71: "üêô Poulpe", 73: "üêü Poisson", 74: "üê† Poisson Tropical", 75: "üê° Poisson-globe", 76: "ü™º M√©duse", 77: "ü¶à Requin", 78: "üêã Baleine", 79: "üêã Baleine (2)", 80: "ü¶ê Crevette", 81: "ü¶û Homard", 82: "üê¨ Dauphin", 86: "ü¶Ä Crabe", 85: "üêå Escargot",
            61: "ü¶£ Mammouth", 63: "ü¶Ñ Licorne", 64: "üêâ Dragon", 65: "ü¶ñ T-Rex", 83: "üê¶‚Äçüî• Ph√©nix", 84: "ü¶ï Diplodocus",
            66: "üëΩ Stitch", 67: "‚õÑ Bonhomme de Neige", 68: "ü¶Ü Canard √âcarlate", 69: "‚òÉÔ∏è Personne de Neige", 70: "üëΩ Alien", 99: "üéÉ Citrouille", 100: "üëª Fant√¥me", 101: "üßõ Vampire"
        };

        const TERRAIN_NAMES = {
            plains: "üåø Plaines",
            forest: "üå≤ For√™t",
            coast: "üåä C√¥te",
            mountain: "üèîÔ∏è Montagne",
            desert: "üèúÔ∏è D√©sert",
            swamp: "üêä Marais",
            ruins: "üèõÔ∏è Ruines",
            cave: "üï≥Ô∏è Caverne"
        };

        let PREFERENCES = {};
        let currentTerrain = 'all';
        let availableBranches = [];

        async function loadBranches() {
            const branchSelect = document.getElementById('branchSelect');
            try {
                const response = await fetch('https://api.github.com/repos/Crownicles/Crownicles/branches?per_page=100');
                if (!response.ok) throw new Error('Impossible de charger les branches');
                
                const branches = await response.json();
                availableBranches = branches.map(b => b.name).sort((a, b) => {
                    // Prioritize common branches
                    const priority = ['develop', 'master', 'main'];
                    const aIndex = priority.indexOf(a);
                    const bIndex = priority.indexOf(b);
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    if (aIndex !== -1) return -1;
                    if (bIndex !== -1) return 1;
                    return a.localeCompare(b);
                });
                
                branchSelect.innerHTML = availableBranches.map(branch => 
                    `<option value="${branch}" ${branch === 'develop' ? 'selected' : ''}>${branch}</option>`
                ).join('');
                
            } catch (error) {
                branchSelect.innerHTML = '<option value="develop">develop (d√©faut)</option>';
                console.error('Erreur chargement branches:', error);
            }
        }

        function showLoading(show, message = 'Chargement en cours...') {
            const loadingStatus = document.getElementById('loadingStatus');
            const statusText = document.getElementById('statusText');
            const loadIcon = document.getElementById('loadIcon');
            const loadBtn = document.getElementById('loadGitHubData');
            
            loadingStatus.style.display = show ? 'block' : 'none';
            statusText.textContent = message;
            loadBtn.disabled = show;
            
            if (show) {
                loadIcon.classList.add('fa-spin');
            } else {
                loadIcon.classList.remove('fa-spin');
            }
        }

        function parseTerrainArray(content) {
            // Extract all quoted strings from array content
            const matches = content.match(/"([^"]+)"/g);
            if (!matches) return [];
            return matches.map(s => s.replace(/"/g, ''));
        }

        async function fetchPreferences(branch = 'develop') {
            const url = `https://raw.githubusercontent.com/Crownicles/Crownicles/${branch}/Lib/src/constants/ExpeditionConstants.ts`;
            showLoading(true, `Chargement depuis la branche "${branch}"...`);
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Branche "${branch}" introuvable (HTTP ${response.status})`);
                const text = await response.text();
                
                // Extract the PET_EXPEDITION_PREFERENCES object
                const startMarker = 'PET_EXPEDITION_PREFERENCES';
                const startIndex = text.indexOf(startMarker);
                if (startIndex === -1) throw new Error('PET_EXPEDITION_PREFERENCES non trouv√© dans le fichier');
                
                // Find the opening brace after the marker
                const assignIndex = text.indexOf('= {', startIndex);
                if (assignIndex === -1) throw new Error('Format de fichier incompatible');
                
                let braceCount = 1;
                let currentPos = assignIndex + 3; // After '= {'
                let objectContent = '';
                
                while (braceCount > 0 && currentPos < text.length) {
                    const char = text[currentPos];
                    if (char === '{') braceCount++;
                    if (char === '}') braceCount--;
                    if (braceCount > 0) objectContent += char;
                    currentPos++;
                }

                const newPrefs = {};
                
                // Split by top-level entries (number followed by colon)
                // Match pattern: number: { liked: [...], disliked: [...] }
                const entryRegex = /(\d+):\s*\{[^{}]*liked:\s*\[([\s\S]*?)\][^{}]*disliked:\s*\[([\s\S]*?)\][^{}]*\}/g;
                let match;
                
                while ((match = entryRegex.exec(objectContent)) !== null) {
                    const id = parseInt(match[1]);
                    const liked = parseTerrainArray(match[2]);
                    const disliked = parseTerrainArray(match[3]);
                    newPrefs[id] = { liked, disliked };
                }

                if (Object.keys(newPrefs).length === 0) {
                    throw new Error('Aucune pr√©f√©rence de familier trouv√©e dans le fichier');
                }

                PREFERENCES = newPrefs;
                showLoading(false);
                document.getElementById('statusText').textContent = `‚úì ${Object.keys(newPrefs).length} familiers charg√©s depuis "${branch}"`;
                document.getElementById('loadingStatus').style.display = 'block';
                document.getElementById('loadingStatus').innerHTML = `<i class="fas fa-check" style="color: var(--success);"></i> <span>${Object.keys(newPrefs).length} familiers charg√©s depuis "${branch}"</span>`;
                
                renderPets();
            } catch (error) {
                showLoading(false);
                document.getElementById('loadingStatus').style.display = 'block';
                document.getElementById('loadingStatus').innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> <span>Erreur: ${error.message}</span>`;
            }
        }

        function renderPets() {
            const grid = document.getElementById('petGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const prefFilter = document.getElementById('preferenceFilter').value;
            const sortVal = document.getElementById('sortBy').value;
            
            grid.innerHTML = '';

            let petList = Object.entries(PREFERENCES).map(([id, prefs]) => ({
                id,
                name: PET_NAMES[id] || `Familier ${id}`,
                prefs
            }));

            // Filtering
            petList = petList.filter(pet => {
                const name = pet.name.toLowerCase();
                if (search && !name.includes(search) && !pet.id.includes(search)) return false;
                
                if (currentTerrain !== 'all') {
                    if (prefFilter === 'liked' && !pet.prefs.liked.includes(currentTerrain)) return false;
                    if (prefFilter === 'disliked' && !pet.prefs.disliked.includes(currentTerrain)) return false;
                    if (prefFilter === 'all' && !pet.prefs.liked.includes(currentTerrain) && !pet.prefs.disliked.includes(currentTerrain)) return false;
                } else if (prefFilter !== 'all') {
                    if (prefFilter === 'liked' && pet.prefs.liked.length === 0) return false;
                    if (prefFilter === 'disliked' && pet.prefs.disliked.length === 0) return false;
                }
                return true;
            });

            // Sorting
            petList.sort((a, b) => {
                switch(sortVal) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'likesCount': return b.prefs.liked.length - a.prefs.liked.length;
                    case 'dislikesCount': return b.prefs.disliked.length - a.prefs.disliked.length;
                    default: return parseInt(a.id) - parseInt(b.id);
                }
            });

            petList.forEach(({id, name, prefs}) => {
                const card = document.createElement('div');
                card.className = 'pet-card';

                const likedTags = prefs.liked.map(t => `<span class="tag ${t}">${TERRAIN_NAMES[t] || t}</span>`).join('');
                const dislikedTags = prefs.disliked.map(t => `<span class="tag ${t}">${TERRAIN_NAMES[t] || t}</span>`).join('');

                card.innerHTML = `
                    <div class="pet-header">
                        <span class="pet-name">${name}</span>
                        <span class="pet-id">#${id}</span>
                    </div>
                    ${likedTags ? `
                        <div class="preference-section liked">
                            <div class="preference-title">Aime (${prefs.liked.length})</div>
                            <div class="tag-list">${likedTags}</div>
                        </div>
                    ` : ''}
                    ${dislikedTags ? `
                        <div class="preference-section disliked">
                            <div class="preference-title">D√©teste (${prefs.disliked.length})</div>
                            <div class="tag-list">${dislikedTags}</div>
                        </div>
                    ` : ''}
                    ${!likedTags && !dislikedTags ? '<div class="preference-section"><div class="preference-title">Neutre</div></div>' : ''}
                `;
                grid.appendChild(card);
            });
        }

        // Initialize terrain filters
        const terrainFilterContainer = document.getElementById('terrainFilters');
        
        // Add "All" filter first
        const allFilter = document.createElement('div');
        allFilter.className = 'terrain-filter active';
        allFilter.dataset.terrain = 'all';
        allFilter.textContent = 'Tous les terrains';
        allFilter.onclick = () => {
            document.querySelector('.terrain-filter.active').classList.remove('active');
            allFilter.classList.add('active');
            currentTerrain = 'all';
            renderPets();
        };
        terrainFilterContainer.appendChild(allFilter);
        
        // Add terrain-specific filters
        for (const [key, name] of Object.entries(TERRAIN_NAMES)) {
            const el = document.createElement('div');
            el.className = 'terrain-filter';
            el.dataset.terrain = key;
            el.textContent = name;
            el.onclick = () => {
                document.querySelector('.terrain-filter.active').classList.remove('active');
                el.classList.add('active');
                currentTerrain = key;
                renderPets();
            };
            terrainFilterContainer.appendChild(el);
        }

        document.getElementById('searchInput').oninput = renderPets;
        document.getElementById('preferenceFilter').onchange = renderPets;
        document.getElementById('sortBy').onchange = renderPets;
        document.getElementById('loadGitHubData').onclick = () => {
            const branch = document.getElementById('branchSelect').value || 'develop';
            fetchPreferences(branch);
        };

        // Initial load - load branches first, then data
        window.onload = async () => {
            await loadBranches();
            fetchPreferences('develop');
        };
    </script>
</body>
</html>
